name: Streamlit è‡ªåŠ¨å”¤é†’

on:
  workflow_dispatch:          # å…è®¸æ‰‹åŠ¨æŒ‰é’®è§¦å‘
  repository_dispatch:        # å…è®¸ Webhook è§¦å‘
    types: [service-down-alert]

jobs:
  wakeup:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ‰“å°è°ƒè¯•ä¿¡æ¯ (çœ‹çœ‹ Komari åˆ°åº•å‘æ¥äº†ä»€ä¹ˆ)
      - name: ğŸ” è°ƒè¯•ä¿¡æ¯
        run: |
          echo "è§¦å‘æ¥æº: ${{ github.event_name }}"
          echo "æ”¶åˆ°çš„æ¶ˆæ¯å†…å®¹: '${{ github.event.client_payload.message }}'"

      # 2. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # 3. å‡†å¤‡æµè§ˆå™¨ç¯å¢ƒ (å”¤é†’ Streamlit å¿…é¡»)
      - name: ğŸŒ è®¾ç½® Chrome æµè§ˆå™¨
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      # 4. å‡†å¤‡ Python
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 5. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–åº“
        run: |
          python -m pip install --upgrade pip
          pip install selenium webdriver-manager

      # 6. æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œå”¤é†’
      - name: ğŸš€ åˆ¤æ–­å¹¶æ‰§è¡Œ
        env:
          # å¿…é¡»åœ¨ä»“åº“ Secrets é‡Œé…ç½® STREAMLIT_APP_URL
          STREAMLIT_APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
          # è·å–æ¶ˆæ¯å†…å®¹
          ALARM_MSG: ${{ github.event.client_payload.message }}
          # è·å–è§¦å‘ç±»å‹
          EVENT_NAME: ${{ github.event_name }}
        run: |
          echo "æ­£åœ¨åˆ†æè§¦å‘æ¡ä»¶..."
          
          # é€»è¾‘åˆ¤æ–­ï¼š
          # 1. å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ (workflow_dispatch) -> ç›´æ¥è¿è¡Œ
          # 2. å¦‚æœæ¶ˆæ¯å†…å®¹($ALARM_MSG)é‡ŒåŒ…å« "streamlit" (grep -iq å¿½ç•¥å¤§å°å†™) -> è¿è¡Œ
          
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]] || echo "$ALARM_MSG" | grep -iq "streamlit"; then
            
            echo "âœ… æ¡ä»¶æ»¡è¶³ï¼(æ‰‹åŠ¨è§¦å‘ æˆ– æ£€æµ‹åˆ°å…³é”®è¯ 'streamlit')"
            echo "æ­£åœ¨å¯åŠ¨ Python å”¤é†’è„šæœ¬..."
            
            if [ -f "keep/streamlit-keep.py" ]; then
              python keep/streamlit-keep.py
            else
              echo "âŒ ä¸¥é‡é”™è¯¯: æ‰¾ä¸åˆ° keep/streamlit-keep.py æ–‡ä»¶ï¼"
              echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
              ls -R
              exit 1
            fi
            
          else
            echo "ğŸ›‘ æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡æ‰§è¡Œã€‚"
            echo "åŸå› : è¿™æ˜¯ä¸€ä¸ª Webhook æŠ¥è­¦ï¼Œä½†æ¶ˆæ¯å†…å®¹é‡Œæ²¡æ‰¾åˆ° 'streamlit'ã€‚"
            echo "æ”¶åˆ°çš„æ¶ˆæ¯å…¨æ–‡: [$ALARM_MSG]"
          fi
