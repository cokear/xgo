name: Streamlit è‡ªåŠ¨å”¤é†’

on:
  workflow_dispatch:          # å…è®¸æ‰‹åŠ¨æŒ‰é’®è§¦å‘
  repository_dispatch:        # å…è®¸ Webhook è§¦å‘
    types: [service-down-alert] # å¯¹åº” Webhook Body ä¸­çš„ event_type
  # schedule:                 # (å¯é€‰) å®šæ—¶ä¿æ´»
  #   - cron: '0 */4 * * *'   # æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  wakeup:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. æ£€æŸ¥è§¦å‘æ¥æº
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "ğŸ“¢ è§¦å‘ç±»å‹: Webhook é€šçŸ¥ (æœåŠ¡ç¦»çº¿)"
            echo "ğŸ“ äº‹ä»¶å†…å®¹: ${{ github.event.client_payload.message }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ğŸ‘† è§¦å‘ç±»å‹: æ‰‹åŠ¨è§¦å‘"
          else
            echo "â° è§¦å‘ç±»å‹: å®šæ—¶ä»»åŠ¡"
          fi

      - name: 2. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 3. è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # Streamlit å”¤é†’éœ€è¦çœŸå®çš„æµè§ˆå™¨ç¯å¢ƒ
      - name: 4. è®¾ç½® Chrome æµè§ˆå™¨
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: 5. å®‰è£…ä¾èµ– (Selenium)
        run: |
          python -m pip install --upgrade pip
          # å¦‚æœä½ çš„ä»“åº“é‡Œæ²¡æœ‰ requirements.txtï¼Œå¯ä»¥ç›´æ¥åœ¨è¿™é‡Œå®‰è£…
          pip install selenium webdriver-manager

      - name: 6. æ‰§è¡Œå”¤é†’è„šæœ¬
        env:
          # è¯·ç¡®ä¿åœ¨ GitHub ä»“åº“ Settings -> Secrets ä¸­è®¾ç½®äº†æ­¤å˜é‡
          STREAMLIT_APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
        run: |
          # ç¡®ä¿ keep ç›®å½•å­˜åœ¨ï¼Œå¦‚æœä½ çš„è„šæœ¬åœ¨æ ¹ç›®å½•ï¼Œå»æ‰ keep/
          if [ -f "keep/streamlit-keep.py" ]; then
            python keep/streamlit-keep.py
          else
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ°å”¤é†’è„šæœ¬ keep/streamlit-keep.py"
            exit 1
          fi
