name: Streamlit 自动唤醒

on:
  workflow_dispatch:          # 允许手动按钮触发
  repository_dispatch:        # 允许 Webhook 触发
    types: [service-down-alert]

jobs:
  wakeup:
    runs-on: ubuntu-latest
    # 【核心修改】只在手动触发，或者监控名称为 'streamlit' 时才运行
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.client_payload.monitor_name == 'streamlit' }}

    steps:
      - name: 1. 记录触发来源
        run: |
          echo "触发来源: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "报警的机器名称: ${{ github.event.client_payload.monitor_name }}"
          fi

      - name: 2. 检出代码
        uses: actions/checkout@v4

      - name: 3. 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: 4. 设置 Chrome 浏览器 (Selenium 需要)
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: 5. 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install selenium webdriver-manager

      - name: 6. 执行唤醒脚本
        env:
          # 确保你在 GitHub 仓库 Secrets 里填了你的 Streamlit 网址
          STREAMLIT_APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
        run: |
          # 这里假设你的脚本在 keep 文件夹下，名字叫 streamlit-keep.py
          if [ -f "keep/streamlit-keep.py" ]; then
            python keep/streamlit-keep.py
          else
            echo "❌ 找不到唤醒脚本，请检查文件路径"
            exit 1
          fi
